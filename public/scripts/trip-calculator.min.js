Date.prototype.formattedDateString=function(){var c=this.getFullYear().toString();var b=(this.getMonth()+1).toString();var a=this.getDate().toString();return c+"-"+(b[1]?b:"0"+b[0])+"-"+(a[1]?a:"0"+a[0])};var products=localStorage.getItem("rawProducts")?JSON.parse(localStorage.getItem("rawProducts")):{};var distances=localStorage.getItem("distances")?JSON.parse(localStorage.getItem("distances")):{};var distanceXHR;var AlcoholTrip={Init:function(){AlcoholTrip.AddEvents();AlcoholTrip.Cart.draw();AlcoholTrip.Locator.draw();AlcoholTrip.Gas.Consumption.draw();AlcoholTrip.Distance.update()},Container:{result:$("#search_result"),searchBar:$("#product_search"),cart:$("#cart"),clearHelper:$(".clear-helper")},AddEvents:function(){var a;AlcoholTrip.Container.searchBar.focus();AlcoholTrip.Container.searchBar.keyup(function(b){if(a){a.abort()}AlcoholTrip.Container.clearHelper.show();if(b.target.value.length>=3){a=$.ajax({type:"GET",url:"/json/AlcoholTrip/products.json?search="+encodeURI(b.target.value),success:AlcoholTrip.Search.add,error:function(e,c,d){if(e.statusText!="abort"){AlcoholTrip.Container.result.html("<p class='network-error'>Kunde inte ansluta till servern</p>")}}})}else{if(b.target.value.length==0){AlcoholTrip.Container.result.empty();AlcoholTrip.Container.clearHelper.hide()}}});AlcoholTrip.Container.clearHelper.click(function(){AlcoholTrip.Container.searchBar.val("");AlcoholTrip.Container.result.empty();AlcoholTrip.Container.clearHelper.hide()});$("#search_form").submit(function(b){b.preventDefault()});AlcoholTrip.Container.cart.on("click",".remove",function(c){var b=$(this);if(!b.hasClass("remove")){b=b.closest(".remove")}var d=b.data("remove");AlcoholTrip.Cart.remove(d)});AlcoholTrip.Container.cart.on("click",".product",function(c){var b=$(this);if(!b.hasClass("product")){b=b.closest(".product")}var d=b.data("id");AlcoholTrip.Cart.add(d)});AlcoholTrip.Container.result.on("click","li",function(b){var c=$(this).data("id");AlcoholTrip.Cart.add(c)});$("#gasConsumption").on("change",function(){AlcoholTrip.Gas.Consumption.set($(this).val());AlcoholTrip.Gas.Consumption.update()});$("#location").on("change",AlcoholTrip.Distance.update);$("#gas_type").on("change",AlcoholTrip.Result.calculate);$("#destination").on("change",AlcoholTrip.Distance.update);$("#view_results").on("click",AlcoholTrip.Result.showDetails);$("#cart_menu").click(function(b){$("body").toggleClass("active")})},Search:{add:function(b){var a="";AlcoholTrip.Container.result.empty();b.forEach(function(c){products[c.id]=c;localStorage.setItem("rawProducts",JSON.stringify(products));a+='<li class="product" data-id="'+c.id+'"><span class="title">'+c.name+" ("+c.alcohol+')</span><span class="producer">Producerad av:'+c.producer+'</span><span class="price">'+c.price+'kr</span><span class="container">'+c.volume+"ml ("+c.container+")</span></li>"});if(a!=""){AlcoholTrip.Container.result.html("<ul>"+a+"</ul>")}}},Result:{showDetails:function(){var c=AlcoholTrip.Cart.total;var d=AlcoholTrip.Cart.borderPrice+(AlcoholTrip.Gas.Consumption.liter*12.48*2);var a='<div id="result_details">';a+="<span><strong>Bensinförbrukning:</strong> "+parseFloat(AlcoholTrip.Gas.Consumption.get())+"</span>";a+="<span><strong>Avstånd:</strong> "+Math.round(AlcoholTrip.Distance.mile)+" mil</span>";a+="<span><strong>Literförbrukning:</strong> "+Math.round(AlcoholTrip.Gas.Consumption.liter*2)+" liter</span>";a+="<span><strong>"+AlcoholTrip.Gas.Price.getText()+"pris:</strong> "+AlcoholTrip.Gas.Price.getPrice().toFixed(2)+"kr/liter</span>";a+="<span><strong>Total resekostnad:</strong> "+Math.round(AlcoholTrip.Gas.Consumption.liter*AlcoholTrip.Gas.Price.getPrice()*2)+"kr</span>";a+="<span><strong>Alkoholpris:</strong> "+Math.round(AlcoholTrip.Cart.borderPrice)+"kr</span>";a+="<span><strong>Systemetpris:</strong> "+Math.round(AlcoholTrip.Cart.total)+"kr</span>";a+="</div>";var b=d<c?"success":"error";swal({title:"Detaljer",text:a,html:true,type:b})},calculate:function(){var c=AlcoholTrip.Cart.total;var d=AlcoholTrip.Cart.borderPrice+(AlcoholTrip.Gas.Consumption.liter*AlcoholTrip.Gas.Price.getPrice()*2);var a=$("#result");if(c){var b;if(d<c){b='<p class="success">Du sparar '+Math.round(c-d)+"kr på att åka iväg</p>"}else{if(d==c){b='<p class="error">Du går jämt upp på åka iväg,<br/> är det värt det?</p>'}else{b='<p class="error">Du sparar '+Math.round(d-c)+"kr<br/>på att stanna hemma</p>"}}$("#result_banner").html(b);a.show()}else{a.hide()}}},Gas:{Price:{isValid:function(){var b=localStorage.getItem("gasPrice");b=JSON.parse(b);if(!b){return false}var a=new Date();return b!=a.formattedDateString()},get:function(){if(AlcoholTrip.Gas.Price.isValid()){return JSON.parse(localStorage.getItem("gasPrice"))}else{var a=new Date();$.ajax({type:"GET",url:"/json/AlcoholTrip/gas_price.json?version="+a.formattedDateString(),success:function(b){console.log("got new price",b);localStorage.setItem("gasPrice",JSON.stringify(b));return JSON.parse(localStorage.getItem("gasPrice"))}})}},getPrice:function(){var a=AlcoholTrip.Gas.Price.get();var b=$("#gas_type").val();return a[b]},getText:function(){return $("#gas_type option:selected").text()}},Consumption:{liter:0,update:function(){AlcoholTrip.Gas.Consumption.liter=AlcoholTrip.Distance.mile*parseFloat(AlcoholTrip.Gas.Consumption.get());AlcoholTrip.Result.calculate()},get:function(){if(!localStorage.getItem("gasConsumption")){AlcoholTrip.Gas.Consumption.set($("#gasConsumption").val())}return localStorage.getItem("gasConsumption")},set:function(a){localStorage.setItem("gasConsumption",a)},draw:function(){var a=AlcoholTrip.Gas.Consumption.get();if(a){$("#gasConsumption").val(a)}}}},Distance:{mile:0,update:function(){var b=$("#location").val();var a=$("#destination").val();if(b&&a){if(!distances[b]){distances[b]={}}if(distances[b][a]){AlcoholTrip.Distance.mile=distances[b][a];AlcoholTrip.Gas.Consumption.update()}else{distanceXHR=$.ajax({type:"GET",url:"/json/AlcoholTrip/distance.json?from="+encodeURIComponent(b)+"&to="+encodeURIComponent(a),success:function(c){AlcoholTrip.Distance.mile=parseInt(c)/10000;AlcoholTrip.Gas.Consumption.update();distances[b][a]=AlcoholTrip.Distance.mile;localStorage.setItem("distances",JSON.stringify(distances))}})}}},has:function(a){return !!distances[a]}},Locator:{has:function(){var a=localStorage.getItem("userCity");return a!=null},update:function(){if(navigator.geolocation){navigator.geolocation.getCurrentPosition(a,b)}function a(c){var e=c.coords.latitude;var d=c.coords.longitude;$.ajax({type:"GET",url:"/json/AlcoholTrip/location.json?lat="+e+"&long="+d,success:function(f){AlcoholTrip.Locator.set(f);AlcoholTrip.Locator.draw()}})}function b(){console.error("Could not retrieve location")}},set:function(a){localStorage.setItem("userCity",a)},get:function(){if(!AlcoholTrip.Locator.has()){AlcoholTrip.Locator.update()}return localStorage.getItem("userCity")},draw:function(){var b=AlcoholTrip.Locator.get();var a=$("#location");if(!$("#location option[value='"+b+"']").length&&b){a.append('<option value="'+b+'">'+b+"</option>");a.val(b).change()}}},Cart:{total:0,borderPrice:0,get:function(){var a=sessionStorage.getItem("products");return a?JSON.parse(a):{}},add:function(a){swal({title:"Steg 1(2)",text:'Hur många vill du köpa av "'+products[a].name+'"?',type:"input",inputType:"number",inputValue:(AlcoholTrip.Cart.get()[a]?AlcoholTrip.Cart.get()[a].qty:null),showCancelButton:true,confirmButtonColor:"#5dc2f1",confirmButtonText:"Gå vidare",cancelButtonText:"Avbryt",closeOnConfirm:false,closeOnCancel:true},function(b){if(b===false){return false}if(b<=0){swal.showInputError("Du måste lägga till minst en vara!");return false}swal({title:"Steg 2(2)",text:"Hur mycket kostar det i bordershoppen? På systemet kostar det "+(Math.round(products[a].price)*b)+"kr",type:"input",inputType:"number",inputValue:(AlcoholTrip.Cart.get()[a]?AlcoholTrip.Cart.get()[a].price:null),showCancelButton:true,confirmButtonColor:"#5dc2f1",confirmButtonText:"Lägg till",cancelButtonText:"Avbryt",closeOnConfirm:false,closeOnCancel:true},function(d){if(d===false){return false}if(d<=0){swal.showInputError("Det kan inte vara gratis!");return false}var c=AlcoholTrip.Cart.get();c[a]={item:products[a],qty:b,price:d,localPrice:b*products[a].price};sessionStorage.setItem("products",JSON.stringify(c));AlcoholTrip.Cart.draw();AlcoholTrip.Result.calculate();swal.close()})})},draw:function(){var a="";AlcoholTrip.Cart.total=0;AlcoholTrip.Cart.borderPrice=0;$.each(AlcoholTrip.Cart.get(),function(d,c){var b=c.item;AlcoholTrip.Cart.total+=parseFloat(b.price)*parseFloat(c.qty);AlcoholTrip.Cart.borderPrice+=parseFloat(c.price);a+='<li class="cart-item" data-id="'+d+'"><div class="remove" data-remove="'+d+'"><i class="fa fa-times-circle"></i></div><div class="product" data-id="'+d+'"><span class="title">'+b.name+" ("+b.alcohol+')</span><span class="price">'+c.qty+"st á "+b.price+"kr ("+Math.round(c.localPrice,2)+'kr)</span><span class="borderprice">'+c.price+"kr på bordershop</span></div></li>"});if(a!=""){a="<ul>"+a+"</ul><p>Totalt på systembolaget:"+AlcoholTrip.Cart.total+"kr</p><p>Totalt på bordershop:"+AlcoholTrip.Cart.borderPrice+"kr</p>"}else{a="<p>Din varukorg är tom...</p>"}$("#cart").html(a)},remove:function(b){var a=AlcoholTrip.Cart.get();if(a[b]){delete a[b]}sessionStorage.setItem("products",JSON.stringify(a));AlcoholTrip.Cart.draw();AlcoholTrip.Result.calculate()},empty:function(b){var a={};sessionStorage.setItem("products",JSON.stringify(a));AlcoholTrip.Cart.draw()}}};$(document).ready(AlcoholTrip.Init);
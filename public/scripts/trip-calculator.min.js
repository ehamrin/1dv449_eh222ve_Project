var products=localStorage.getItem("rawProducts")?JSON.parse(localStorage.getItem("rawProducts")):{};var distances=localStorage.getItem("distances")?JSON.parse(localStorage.getItem("distances")):{};var distanceXHR;var Result={showDetails:function(){var c=Cart.total;var d=Cart.borderPrice+(GasConsumption.liter*12.48*2);var a='<div id="result_details">';a+="<span><strong>Bensinförbrukning:</strong> "+parseFloat(Gas.get())+"</span>";a+="<span><strong>Avstånd:</strong> "+Math.round(Distance.mile)+" mil</span>";a+="<span><strong>Literförbrukning:</strong> "+Math.round(GasConsumption.liter*2)+" liter</span>";a+="<span><strong>"+GasPrice.getText()+"pris:</strong> "+GasPrice.getPrice().toFixed(2)+"kr/liter</span>";a+="<span><strong>Total resekostnad:</strong> "+Math.round(GasConsumption.liter*GasPrice.getPrice()*2)+"kr</span>";a+="<span><strong>Alkoholpris:</strong> "+Math.round(Cart.borderPrice)+"kr</span>";a+="<span><strong>Systemetpris:</strong> "+Math.round(Cart.total)+"kr</span>";a+="</div>";var b=d<c?"success":"error";swal({title:"Detaljer",text:a,html:true,type:b})},calculate:function(){var c=Cart.total;var d=Cart.borderPrice+(GasConsumption.liter*GasPrice.getPrice()*2);var a=$("#result");if(c){var b;if(d<c){b='<p class="success">Du sparar '+Math.round(c-d)+"kr på att åka iväg</p>"}else{if(d==c){b='<p class="error">Du går jämt upp på åka iväg,<br/> är det värt det?</p>'}else{b='<p class="error">Du sparar '+Math.round(d-c)+"kr<br/>på att stanna hemma</p>"}}$("#result_banner").html(b);a.show()}else{a.hide()}}};var GasPrice={isValid:function(){var b=localStorage.getItem("gasPrice");b=JSON.parse(b);if(!b){return false}var a=new Date();var c=new Date(b.date);a.setHours(0,0,0,0);c.setHours(0,0,0,0);return a.getTime()>=c.getTime()},get:function(){if(GasPrice.isValid()){return JSON.parse(localStorage.getItem("gasPrice"))}else{$.ajax({type:"GET",url:"/json/AlcoholTrip/gas_price.json",success:function(a){console.log("got new price",a);localStorage.setItem("gasPrice",JSON.stringify(a));return JSON.parse(localStorage.getItem("gasPrice"))}})}},getPrice:function(){var a=GasPrice.get();var b=$("#gas_type").val();return a[b]},getText:function(){return $("#gas_type option:selected").text()}};var GasConsumption={liter:0,update:function(){GasConsumption.liter=Distance.mile*parseFloat(Gas.get());Result.calculate()}};var Distance={mile:0,update:function(){var b=$("#location").val();var a=$("#destination").val();if(b&&a){if(!distances[b]){distances[b]={}}if(distances[b][a]){Distance.mile=distances[b][a];GasConsumption.update()}else{distanceXHR=$.ajax({type:"GET",url:"/json/AlcoholTrip/distance.json?from="+encodeURIComponent(b)+"&to="+encodeURIComponent(a),success:function(c){Distance.mile=parseInt(c)/10000;GasConsumption.update();distances[b][a]=Distance.mile;localStorage.setItem("distances",JSON.stringify(distances))}})}}},has:function(a){return !!distances[a]}};var Gas={get:function(){if(!localStorage.getItem("gasConsumption")){Gas.set($("#gasConsumption").val())}return localStorage.getItem("gasConsumption")},set:function(a){localStorage.setItem("gasConsumption",a)},draw:function(){var a=Gas.get();if(a){$("#gasConsumption").val(a)}}};var Locator={has:function(){var a=localStorage.getItem("userCity");return a!=null},update:function(){if(navigator.geolocation){navigator.geolocation.getCurrentPosition(a,b)}function a(c){var e=c.coords.latitude;var d=c.coords.longitude;$.ajax({type:"GET",url:"/json/AlcoholTrip/location.json?lat="+e+"&long="+d,success:function(f){Locator.set(f);Locator.draw()}})}function b(){console.error("Could not retrieve location")}},set:function(a){localStorage.setItem("userCity",a)},get:function(){if(!Locator.has()){Locator.update()}return localStorage.getItem("userCity")},draw:function(){var b=Locator.get();var a=$("#location");if(!$("#location option[value='"+b+"']").length&&b){a.append('<option value="'+b+'">'+b+"</option>");a.val(b).change()}}};var Cart={total:0,borderPrice:0,get:function(){var a=sessionStorage.getItem("products");return a?JSON.parse(a):{}},add:function(a){swal({title:"Steg 1(2)",text:'Hur många vill du köpa av "'+products[a].name+'"?',type:"input",inputType:"number",inputValue:(Cart.get()[a]?Cart.get()[a].qty:null),showCancelButton:true,confirmButtonColor:"#5dc2f1",confirmButtonText:"Gå vidare",cancelButtonText:"Avbryt",closeOnConfirm:false,closeOnCancel:true},function(b){if(b===false){return false}if(b<=0){swal.showInputError("Du måste lägga till minst en vara!");return false}swal({title:"Steg 2(2)",text:"Hur mycket kostar det i bordershoppen? På systemet kostar det "+(Math.round(products[a].price)*b)+"kr",type:"input",inputType:"number",inputValue:(Cart.get()[a]?Cart.get()[a].price:null),showCancelButton:true,confirmButtonColor:"#5dc2f1",confirmButtonText:"Lägg till",cancelButtonText:"Avbryt",closeOnConfirm:false,closeOnCancel:true},function(d){if(d===false){return false}if(d<=0){swal.showInputError("Det kan inte vara gratis!");return false}var c=Cart.get();c[a]={item:products[a],qty:b,price:d,localPrice:b*products[a].price};sessionStorage.setItem("products",JSON.stringify(c));Cart.draw();Result.calculate();swal.close()})})},draw:function(){var a="";Cart.total=0;Cart.borderPrice=0;$.each(Cart.get(),function(d,c){var b=c.item;Cart.total+=parseFloat(b.price)*parseFloat(c.qty);Cart.borderPrice+=parseFloat(c.price);a+='<li class="cart-item" data-id="'+d+'"><div class="remove" data-remove="'+d+'"><i class="fa fa-times-circle"></i></div><div class="product" data-id="'+d+'"><span class="title">'+b.name+" ("+b.alcohol+')</span><span class="price">'+c.qty+"st á "+b.price+"kr ("+c.localPrice+'kr)</span><span class="borderprice">'+c.price+"kr på bordershop</span></div></li>"});if(a!=""){a="<ul>"+a+"</ul><p>Totalt på systembolaget:"+Cart.total+"kr</p><p>Totalt på bordershop:"+Cart.borderPrice+"kr</p>"}else{a="<p>Din varukorg är tom...</p>"}$("#cart").html(a)},remove:function(b){var a=Cart.get();if(a[b]){delete a[b]}sessionStorage.setItem("products",JSON.stringify(a));Cart.draw();Result.calculate()},empty:function(b){var a={};sessionStorage.setItem("products",JSON.stringify(a));Cart.draw()}};$(document).ready(function(){var a=$("#search_result");function b(g){var f="";a.empty();g.forEach(function(h){products[h.id]=h;localStorage.setItem("rawProducts",JSON.stringify(products));f+='<li class="product" data-id="'+h.id+'"><span class="title">'+h.name+" ("+h.alcohol+')</span><span class="producer">Producerad av:'+h.producer+'</span><span class="price">'+h.price+'kr</span><span class="container">'+h.volume+"ml ("+h.container+")</span></li>"});if(f!=""){$("#search_result").html("<ul>"+f+"</ul>")}}var d;var e=$("#product_search");e.focus();e.keyup(function(f){if(d){d.abort()}if(f.target.value.length>=3){d=$.ajax({type:"GET",url:"/json/AlcoholTrip/products.json?search="+f.target.value,success:b})}else{if(f.target.value.length==0){a.empty()}}});$("#search_form").submit(function(f){f.preventDefault()});var c=$("#cart");c.on("click",".remove",function(g){var f=$(this);if(!f.hasClass("remove")){f=f.closest(".remove")}var h=f.data("remove");Cart.remove(h)});c.on("click",".product",function(g){var f=$(this);if(!f.hasClass("product")){f=f.closest(".product")}var h=f.data("id");Cart.add(h)});a.on("click","li",function(f){var g=$(this).data("id");Cart.add(g)});$("#gasConsumption").on("change",function(){Gas.set($(this).val());GasConsumption.update()});$("#location").on("change",Distance.update);$("#gas_type").on("change",Result.calculate);$("#destination").on("change",Distance.update);$("#view_results").on("click",Result.showDetails);$("#cart_menu").click(function(f){$("body").toggleClass("active")});Cart.draw();Locator.draw();Gas.draw();Distance.update()});